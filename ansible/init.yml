---
- hosts: vps64810.roadmanict.nl
  remote_user: root
  vars:
    logwatch_email: geert@gweggemans.nl
    deploy_name: deploy
    deploy_password: arrowned
    deploy_public_keys:
     - ~/.ssh/id_rsa.pub
    required_packages:
     - sudo
     - ufw
     - fail2ban
     - unattended-upgrades
     - logwatch
     - postfix
  tasks:
   - name: Add deploy user
     user: name={{ deploy_name }} password="{{ deploy_password }}" shell=/bin/bash
   - name: Add authorized keys for deploy user
     authorized_key: user={{ deploy_name }} key="{{ lookup('file', item) }}"
     with_items: '{{deploy_public_keys}}'

   - name: Update APT package cache
     apt: update_cache=yes cache_valid_time=3600
   - name: Upgrade APT to the latest packages
     apt: upgrade=safe
   - name: Install required packages
     apt: state=installed pkg={{ item }}
     with_items: '{{required_packages}}'


   - name: Add deploy user to sudoers
     lineinfile: dest=/etc/sudoers
                 regexp="{{ deploy_name }} ALL"
                 line="{{ deploy_name }} ALL=(ALL) NOPASSWD:ALL"
                 state=present

   - name: Adjust APT update intervals
     copy: src=apt_periodic dest=/etc/apt/apt.conf.d/10periodic

   - name: ufw allow ssh
     ufw: rule=limit port=22 proto=tcp
   - name: ufw enable
     ufw: state=enabled policy=deny

   - name: Set up Postfix to relay mail
     debconf: name=postfix
              question='{{ item.question }}'
              value='{{ item.value }}'
              vtype='{{ item.vtype }}'
     with_items:
      - { question: 'postfix/mailname', value: '{{ ansible_fqdn }}', vtype: 'string' }
      - { question: 'postfix/main_mailer_type', value: 'Internet Site', vtype: 'string' }
   - name: Email log summary daily
     lineinfile: dest=/etc/cron.daily/00logwatch
                 regexp="^/usr/sbin/logwatch"
                 line="/usr/sbin/logwatch --output mail --mailto {{ logwatch_email }} --detail high"
                 state=present create=yes

   - name: Disallow password authentication
     lineinfile: dest=/etc/ssh/sshd_config
                 regexp="^PasswordAuthentication"
                 line="PasswordAuthentication no"
                 state=present
     notify: Restart ssh
   - name: Disallow root SSH access
     lineinfile: dest=/etc/ssh/sshd_config
                 regexp="^PermitRootLogin"
                 line="PermitRootLogin no"
                 state=present
     notify: Restart ssh
  handlers:
   - name: Restart ssh
     service: name=ssh state=restarted
